# Active Directory
## どうやって AD への攻撃が成功するのか
### 初期侵入
まずは、一般ユーザの権限を奪う
#### 侵入経路
- フィッシングメールによる ID/Password の漏洩
- VPN / RDP の弱いパスワード (ex. admin/admin)
    - VPN では、VPN 機器の admin/admin などをついて P2S 接続し、情報収集に取り掛かる
    - RDP では、Windows のローカル認証さえ突破できれば、内部ユーザに見える
- 未パッチの端末（Excel/PDF/ブラウザ）
    - 未パッチの Office 系アプリ上でマルウェアが実行される（そのマルウェアはパッチ適用していれば防げる、壊れたファイルとして認識されるだけ）
    - 未パッチのブラウザが悪意のあるWebページにアクセスすると、ローカルに不正にファイル生成する。パッチ適用してればブロック。
- ローカル管理者が共通パスワード
#### point
この時点では、まだ AD 自体は壊れていない

### AD 情報の探索
AD の情報を設計図として描く
#### 行動
- BloodHound で依存関係を可視化
    - AD の依存関係をグラフ化して、攻撃者が管理者になる最短ルートを見つけるツール
    - もともとは、攻撃者向けだったが、Pen Test などに用いられるようになった
- net user /domain などコマンドを使う
- LDAP クエリで管理者、委任関係を列挙
    - AD の設計上、一般ユーザでも LDAP クエリで AD 内の情報をかなり可視化できる
    - 一般ユーザー（Domain Users）でも、通常は LDAP で次のようなディレクトリ情報を読める
        - ユーザー一覧（表示名、部署、メール、電話、役職など属性）
        - グループ一覧・所属関係（誰がどのグループに入っているか）
        - コンピューターアカウント（PC/サーバ名、OS 情報、所属OU など）
        - OU 構造（どんな組織単位があるか）
        - GPO の存在（設定内容の一部は別権限や共有経由で見える場合あり）
        - サービスアカウント関連の一部情報（SPN など）
        - つまり、攻撃者が知りたい **「組織図」「権限の地図」「サーバ一覧」**がかなり揃う

#### ★Point
AD は一般ユーザでも幅広い情報が得られてしまうのが問題

### 重要：権限昇格
ここが AD 攻撃の核心となる
#### 代表例
- Kerberoasting（サービスアカウントのパスワードクラック）
    - 
- AS-REP Roasting（事前認証無しアカウント）
- 不適切な ACL（WriteDACL/GenericAll）
- 委任設定ミス（Unconstrained）
- 古いOSの脆弱性（PrintNightmare など）

#### Point
この権限昇格は、設定ミスに依存する。つまり、設定ミスがなければ基本的には権限昇格されない。

### 横展開
管理者権限さえ奪ってしまえば何でもし放題
- **Pass-the-Hash**：パスワードの平文を知らなくても、ハッシュ値だけで認証できてしまう攻撃
- **Pass-the-Ticket**：Kerberos チケットを盗んで、そのチケットで別のサービスにアクセスする攻撃
- **SMB / WMI / PsExec**：リモートで他の端末にコマンドを実行するための正規ツール（攻撃者も悪用）
- **NTLM Relay**：NTLM 認証を中継して、攻撃者が別のサーバに成りすましでアクセスする攻撃

### 永続化＆破壊
- **DCSync**：ドメインコントローラのふりをして、全ユーザのパスワードハッシュを取得する攻撃
- **Golden Ticket**：偽造した Kerberos チケットで、どのアカウントにもなりすませる最強の永続化手法
- **GPO にバックドア**：グループポリシーに悪意のあるスクリプトを仕込んで、ドメイン内の全端末に自動実行させる
- **AD 破壊、ランサム展開**：AD を暗号化・破壊して身代金要求、組織全体を停止に追い込む


## Kerberoasting って何？
一言でいうと、「AD が正規利用のために新設に渡してくれるものを後からこそっと解読する攻撃」

### 登場人物
- 👤 一般ユーザー（攻撃者がなりすましている）
- 🧑‍💼 サービスアカウント（SQL / Web / バッチなど）
- 🏢 DC（ドメインコントローラ）

### ①SPN を持つアカウントを LDAP で列挙する
= 社内のサービス一覧を見るような行為
-> このサービスはどのアカウント（SPN）に紐づいているかを確認
-> この SPN は人間に紐づくものではなく、サービスに固有のもの

この行為自体は何の問題もない、電話帳を見ているくらいの気持ち。

### ②そのサービス宛の Kerberos チケット (TGS) を要求
＝そのサービス使いたい要求を AD に依頼
→ファイルサーバにアクセスしたいことを伝えるようなイメージ

AD はそのユーザを確認して、ドメイン内のユーザであれば認可として TGS というチケットを発行

### ③チケットを取得
＝TGS を受け取る
→この TGS は、サービスアカウントの**パスワード由来の鍵**で暗号化されている
→サービス本人しか開けない封筒のようなもの

公開鍵暗号化方式にしておけば、パスワードが漏洩する可能性はほぼなくせたが、Kerberos の設計上の折衷案としてパスワード型となっている。

### ④重要!!:チケットを時間をかけて解析
=もらった封筒を家に持ち帰って開けようとする

AD とはもう通信が不要なので、ロックアウトなど気にせず好きなだけ解析ができてしまう。この際、サービスアカウントのパスワードが弱いと解読できる可能性がある。

### ⑤パスワードがバレる
= 攻撃者が開封に成功

サービスアカウントの平文パスワードが分かってしまう。もしそのサービスアカウントが Domain Admin などの強い権限だった場合、または、パスワードが使いまわされている場合、、、一気に権限昇格と横展開をされる。

### Point 
AD としては、クラックされたアカウントに対して礼儀正しく TGS チケットを与えているだけ。これは Kerberos プロトコルの宿命。そういう意味で、やはり水際対策としてドメインユーザの漏洩を防ぐことが最も重大である。


## Defender for Identity は何をしている？
上述のように、Kerberos 的には正しい通信をしているため AD 単体ではそれを攻撃と検知できない。その識別を手助けするのが Defender for Identity。つまり、Defender for Identity は「AD の“正規に見える通信”の中から、人間では気づけない“攻撃の兆候”を振る舞いで検知する」ツール。

### 
