# Active Directory
## どうやって AD への攻撃が成功するのか
### 初期侵入
まずは、一般ユーザの権限を奪う
#### 侵入経路
- フィッシングメールによる ID/Password の漏洩
- VPN / RDP の弱いパスワード (ex. admin/admin)
    - VPN では、VPN 機器の admin/admin などをついて P2S 接続し、情報収集に取り掛かる
    - RDP では、Windows のローカル認証さえ突破できれば、内部ユーザに見える
- 未パッチの端末（Excel/PDF/ブラウザ）
    - 未パッチの Office 系アプリ上でマルウェアが実行される（そのマルウェアはパッチ適用していれば防げる、壊れたファイルとして認識されるだけ）
    - 未パッチのブラウザが悪意のあるWebページにアクセスすると、ローカルに不正にファイル生成する。パッチ適用してればブロック。
- ローカル管理者が共通パスワード
#### point
この時点では、まだ AD 自体は壊れていない

### AD 情報の探索
AD の情報を設計図として描く
#### 行動
- BloodHound で依存関係を可視化
    - AD の依存関係をグラフ化して、攻撃者が管理者になる最短ルートを見つけるツール
    - もともとは、攻撃者向けだったが、Pen Test などに用いられるようになった
- net user /domain などコマンドを使う
- LDAP クエリで管理者、委任関係を列挙
    - AD の設計上、一般ユーザでも LDAP クエリで AD 内の情報をかなり可視化できる
    - 一般ユーザー（Domain Users）でも、通常は LDAP で次のようなディレクトリ情報を読めます。
        - ユーザー一覧（表示名、部署、メール、電話、役職など属性）
        - グループ一覧・所属関係（誰がどのグループに入っているか）
        - コンピューターアカウント（PC/サーバ名、OS 情報、所属OU など）
        - OU 構造（どんな組織単位があるか）
        - GPO の存在（設定内容の一部は別権限や共有経由で見える場合あり）
        - サービスアカウント関連の一部情報（SPN など）
        - つまり、攻撃者が知りたい **「組織図」「権限の地図」「サーバ一覧」**がかなり揃います。

#### point
AD は一般ユーザでも幅広い情報が得られてしまうのが問題

### 重要：権限昇格
ここが AD 攻撃の核心となる
#### 代表例
- Kerberoasting（サービスアカウントのパスワードクラック）
- AS-REP Roasting（事前認証無しアカウント）
- 不適切な ACL（WriteDACL/GenericAll）
- 委任設定ミス（Unconstrained）
- 古いOSの脆弱性（PrintNightmare など）

#### Point
この権限昇格は、設定ミスに依存する。つまり、設定ミスがなければ基本的には権限昇格されない。

### 横展開
管理者権限さえ奪ってしまえば何でもし放題
- Pass-the-Hash
- Pass-the-Ticket
- SMB / WMI / PsExec
- NTLM Relay

### 永続化＆破壊
- DCSync
- Golden Ticket
- GPO にバックドア
- AD 破壊、ランサム展開
