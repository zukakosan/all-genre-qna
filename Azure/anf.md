# Azure NetApp Files
利用手順
1. リソースをデプロイ
2. 容量プールの作成
3. ボリュームの作成

## 容量プールの作成
### QoS 選択
- Auto QoS
    - いちばんよく使われている標準モード
    - ボリュームサイズ × サービスレベル で
    - そのボリュームが使える 最大スループットが自動決定される

容量を増やす ＝ 性能も一緒に増える

```
Premium（64 MiB/s / TiB）
ボリューム 2 TiB
→ 最大 約128 MiB/s
```

- 特徴
✅ 設計がシンプル
✅ 直感的
❌ 性能だけ増やしたいのに容量を増やす必要がある
❌ ボリュームごとに性能が固定される

- 向いているケース
    - 単一ワークロード
    - 性能要求が容量と比例して伸びる
    - ANFを初めて使う構成
    - Manual QoS

### 性能上げるには、容量プールの中に複数ボリューム詰めるより、分散させた方がいい？
基本は分散させるのが安全。ANF は容量プール＝性能の単位であり、これをどう切るかが重要。

前提として、容量プールあたりの総スループットは固定であり、Standard / Premium / Ultra というサービスレベルごとに MiB/s で決まっている。

Auto QoS の場合（多数派）では、分散させる方がよい。Auto QoS では、各ボリュームの上限はボリュームサイズに依存するが、物理的には、同一プール帯域を共有している。つまり、同一プール内に、高負荷ボリュームが複数あると、バーストが被ると遅延が発生する。

例：
```
Premium Pool 4 TiB (256 MiB/s)
 ├─ VolA 2 TiB（DB）
 ├─ VolB 1 TiB（Batch）
 └─ VolC 1 TiB（App）
```
バッチ実行時、VolB が帯域を食うため、VolA の read latency が急増

### 容量によって、帯域が決まっているのに、タイミングがぶつかるとなぜ遅延が発生する？
#### 理由①：ANF の QoS が平均値ベースになっている
ANF の Max Throughput は1秒未満の瞬間最大値を完全制御するものではない。よって、以下のような瞬間的なバーストを認める仕様になっている。

```
0.1秒間に 200 MiB/s 出た
0.9秒間に 50 MiB/s 出た
→ 平均 65 MiB/s（OK）
```

#### 理由②：ストレージI/O は常にバースト
特に ANF は：
- TCP
- NFS / SMB
- Linux page cache / readahead
- SMB credit
の組み合わせで、アプリが「出してるつもり以上」に瞬間I/Oが出るため、帯域が詰まりやすい

#### 理由③：物理バックエンドは完全に分離されているわけではない
容量プールの中では：
- フロントエンド（NFS/SMB）
- バックエンド（NetApp ONTAP系）
- NVMe / SSD
がマルチテナント的に共有されている

帯域制御はできる(平均値ベース)が、内部キューは共有されているため、ほかのボリュームで帯域消費のバーストが走ると、I/O に対するキューが発生。

```
I/O が発行され
↓
それが帯域に変換され
↓
物理帯域を超えると
↓
I/O がキューに積まれ
↓
レイテンシとして観測される
```
#### 理由④：「遅延＝バグ」ではない
「上限内なら絶対にレイテンシが増えない」を実現しようとすると、バーストを認めない設定になり、容量プール内で空いているリソースを活用できない。つまり、平均性能も下がり、コストが増加する。つまり、動的なリソース共有を得意とする仮想化技術・クラウドの特性を全く生かせない。

よって、ANF ではレイテンシに対する SLA は設定していない。

### 容量プールを分けて、物理レベルで分けることへのデメリットは？コストなど
#### デメリット①：容量プールには最低容量がある
容量プールはそもそも最低 4 TiB/Pool であり、小さく切ることはできない。よって使用していない容量にも課金が発生してしまう。

#### デメリット②：スループットが使いきれない
時間帯によって波がある場合でも、余剰容量を容量プール間で共有できないため、コスト効率が悪くなる。つまり、共有のメリットを自ら捨てることになる。
```
Pool A（DB）   4 TiB → 256 MiB/s（常時 60 MiB/s）
Pool B（Batch）4 TiB → 256 MiB/s（夜だけ 200 MiB/s）
```

#### デメリット③：運用・設計の煩雑化
管理対象の Pool が増えていってしまうため、ボリュームの配置場所に迷う

#### じゃあどうするのが「大人の解」か

設計の黄金ルール
「競合すると困るものだけ分ける」

専用 Pool に分けるべきもの
- レイテンシに敏感
    - DB
    - メタデータ多いワークロード
- 同時バーストが読めない
- SLO が厳しい

共有 Pool で混ぜていいもの
- Home directory
- アーカイブ
- 一時ファイル
- 夜間 Batch
